# ğŸ“Š Database Design - BookStore Microservices

## Overview

Dá»± Ã¡n sá»­ dá»¥ng mÃ´ hÃ¬nh **Database per Service** - má»—i microservice cÃ³ database riÃªng Ä‘á»ƒ Ä‘áº£m báº£o:
- **Loose coupling**: CÃ¡c service Ä‘á»™c láº­p vá» data
- **Scalability**: CÃ³ thá»ƒ scale tá»«ng database riÃªng
- **Polyglot persistence**: CÃ³ thá»ƒ dÃ¹ng DB khÃ¡c nhau cho tá»«ng service

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           MICROSERVICES DATABASES                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ identity_dbâ”‚ product_db  â”‚ order_db    â”‚inventory_dbâ”‚ payment_db â”‚promotion â”‚
â”‚   (8081)   â”‚   (8082)    â”‚   (8083)    â”‚   (8084)   â”‚   (new)    â”‚   _db    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” 1. Identity Database (identity_db)

**Service Port**: 8081

### ERD Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          users              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                       â”‚
â”‚    username (UNIQUE)        â”‚
â”‚    email (UNIQUE)           â”‚
â”‚    password (BCrypt)        â”‚
â”‚    full_name                â”‚
â”‚    phone_number             â”‚
â”‚    avatar_url               â”‚
â”‚    role (ENUM)              â”‚
â”‚    enabled                  â”‚
â”‚    email_verified           â”‚
â”‚    phone_verified           â”‚
â”‚    locked                   â”‚
â”‚    lock_reason              â”‚
â”‚    failed_login_attempts    â”‚
â”‚    last_login_at            â”‚
â”‚    created_at               â”‚
â”‚    updated_at               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          â”‚                                  â”‚
    â–¼          â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  user_addresses   â”‚  â”‚   refresh_tokens     â”‚  â”‚  password_reset_tokens   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id             â”‚  â”‚ PK id                â”‚  â”‚ PK id                    â”‚
â”‚ FK user_id        â”‚  â”‚ FK user_id           â”‚  â”‚ FK user_id               â”‚
â”‚    address_type   â”‚  â”‚    token             â”‚  â”‚    token                 â”‚
â”‚    recipient_name â”‚  â”‚    device_info       â”‚  â”‚    expires_at            â”‚
â”‚    phone_number   â”‚  â”‚    ip_address        â”‚  â”‚    used                  â”‚
â”‚    province       â”‚  â”‚    expires_at        â”‚  â”‚    created_at            â”‚
â”‚    district       â”‚  â”‚    revoked           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚    ward           â”‚  â”‚    created_at        â”‚
â”‚    street_address â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚    postal_code    â”‚
â”‚    is_default     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    created_at     â”‚  â”‚  user_login_history      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                       â”‚ PK id                    â”‚
                       â”‚ FK user_id               â”‚
                       â”‚    login_at              â”‚
                       â”‚    ip_address            â”‚
                       â”‚    user_agent            â”‚
                       â”‚    device_type           â”‚
                       â”‚    login_status          â”‚
                       â”‚    failure_reason        â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tables Summary

| Table | Description | Records Est. |
|-------|-------------|--------------|
| `users` | Main user accounts | 10K-1M |
| `user_addresses` | Shipping/billing addresses | 30K-3M |
| `refresh_tokens` | JWT refresh tokens | Active users Ã— 2 |
| `password_reset_tokens` | Password reset links | Low |
| `email_verification_tokens` | Email verification | Low |
| `user_login_history` | Login audit trail | 100K-10M |

---

## ğŸ“¦ 2. Product Database (product_db)

**Service Port**: 8082

### ERD Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    categories      â”‚         â”‚              products                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤ PK id                                   â”‚
â”‚    name            â”‚         â”‚    sku (UNIQUE)                         â”‚
â”‚    slug            â”‚         â”‚    isbn (UNIQUE)                        â”‚
â”‚    description     â”‚         â”‚    title                                â”‚
â”‚    image_url       â”‚         â”‚    slug (UNIQUE)                        â”‚
â”‚ FK parent_id (self)â”‚         â”‚    description                          â”‚
â”‚    display_order   â”‚         â”‚    short_description                    â”‚
â”‚    is_active       â”‚         â”‚    original_price                       â”‚
â”‚    created_at      â”‚         â”‚    selling_price                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    discount_percent                     â”‚
                               â”‚ FK category_id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚ FK publisher_id                         â”‚
â”‚     authors        â”‚         â”‚    publication_date                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚    language                             â”‚
â”‚ PK id              â”‚         â”‚    page_count                           â”‚
â”‚    name            â”‚         â”‚    weight                               â”‚
â”‚    slug            â”‚         â”‚    dimensions                           â”‚
â”‚    biography       â”‚         â”‚    cover_type                           â”‚
â”‚    avatar_url      â”‚         â”‚    thumbnail_url                        â”‚
â”‚    birth_date      â”‚         â”‚    status                               â”‚
â”‚    nationality     â”‚         â”‚    is_featured                          â”‚
â”‚    website         â”‚         â”‚    is_bestseller                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    is_new_arrival                       â”‚
         â”‚                     â”‚    meta_title                           â”‚
         â”‚                     â”‚    meta_description                     â”‚
         â”‚                     â”‚    view_count                           â”‚
         â”‚                     â”‚    sold_count                           â”‚
         â”‚                     â”‚    rating_average                       â”‚
         â”‚                     â”‚    rating_count                         â”‚
         â”‚                     â”‚    created_at                           â”‚
         â”‚                     â”‚    updated_at                           â”‚
         â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                    â”‚
         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    â”‚                               â”‚                       â”‚
         â–¼    â–¼                               â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   product_authors    â”‚         â”‚  product_images  â”‚    â”‚  product_reviews  â”‚
â”‚   (Many-to-Many)     â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚ PK id            â”‚    â”‚ PK id             â”‚
â”‚ PK,FK product_id     â”‚         â”‚ FK product_id    â”‚    â”‚ FK product_id     â”‚
â”‚ PK,FK author_id      â”‚         â”‚    image_url     â”‚    â”‚    user_id        â”‚
â”‚     author_role      â”‚         â”‚    alt_text      â”‚    â”‚    order_item_id  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    display_order â”‚    â”‚    rating (1-5)   â”‚
                                 â”‚    is_primary    â”‚    â”‚    title          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    content        â”‚
â”‚    publishers      â”‚                                   â”‚    pros           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                   â”‚    cons           â”‚
â”‚ PK id              â”‚                                   â”‚    is_verified    â”‚
â”‚    name            â”‚                                   â”‚    is_approved    â”‚
â”‚    slug            â”‚                                   â”‚    helpful_count  â”‚
â”‚    description     â”‚                                   â”‚    created_at     â”‚
â”‚    logo_url        â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚    website         â”‚
â”‚    address         â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚    wishlists      â”‚
                                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                 â”‚ PK id             â”‚
                                 â”‚    user_id        â”‚
                                 â”‚ FK product_id     â”‚
                                 â”‚    added_at       â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tables Summary

| Table | Description | Records Est. |
|-------|-------------|--------------|
| `categories` | Book categories (hierarchical) | 50-500 |
| `authors` | Book authors | 1K-50K |
| `publishers` | Publishing houses | 100-1K |
| `products` | Book catalog | 10K-500K |
| `product_authors` | Many-to-many relationship | 15K-750K |
| `product_images` | Product gallery | 20K-1M |
| `product_reviews` | Customer reviews | 50K-5M |
| `wishlists` | User wishlists | 100K-10M |

---

## ğŸª 3. Inventory Database (inventory_db)

**Service Port**: 8084

### ERD Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     warehouses        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                 â”‚
â”‚    code (UNIQUE)      â”‚
â”‚    name               â”‚
â”‚    address            â”‚
â”‚    city               â”‚
â”‚    phone              â”‚
â”‚    is_active          â”‚
â”‚    is_default         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ 1:N
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              inventory                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                                     â”‚
â”‚    product_id (ref: product_db.products)  â”‚
â”‚ FK warehouse_id                           â”‚
â”‚    sku                                    â”‚
â”‚    quantity                               â”‚
â”‚    reserved_quantity                      â”‚
â”‚    available_quantity (COMPUTED)          â”‚
â”‚    reorder_level                          â”‚
â”‚    reorder_quantity                       â”‚
â”‚    version (Optimistic Lock)              â”‚
â”‚    updated_at                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚
        â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ inventory_movementsâ”‚  â”‚  stock_reservations   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id             â”‚  â”‚ PK id                 â”‚
â”‚ FK inventory_id   â”‚  â”‚ FK inventory_id       â”‚
â”‚    product_id     â”‚  â”‚    product_id         â”‚
â”‚    warehouse_id   â”‚  â”‚    order_id           â”‚
â”‚    movement_type  â”‚  â”‚    quantity           â”‚
â”‚    quantity       â”‚  â”‚    status             â”‚
â”‚    quantity_beforeâ”‚  â”‚    expires_at         â”‚
â”‚    quantity_after â”‚  â”‚    created_at         â”‚
â”‚    reference_type â”‚  â”‚    updated_at         â”‚
â”‚    reference_id   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚    reason         â”‚
â”‚    notes          â”‚
â”‚    created_by     â”‚
â”‚    created_at     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Movement Types

```
STOCK_IN      â†’ Nháº­p hÃ ng tá»« nhÃ  cung cáº¥p
STOCK_OUT     â†’ Xuáº¥t hÃ ng (bÃ¡n)
RESERVED      â†’ Äáº·t trÆ°á»›c cho Ä‘Æ¡n hÃ ng pending
RELEASED      â†’ Giáº£i phÃ³ng khi há»§y Ä‘Æ¡n
ADJUSTMENT    â†’ Äiá»u chá»‰nh (kiá»ƒm kÃª)
TRANSFER_IN   â†’ Chuyá»ƒn kho vÃ o
TRANSFER_OUT  â†’ Chuyá»ƒn kho ra
RETURN        â†’ Tráº£ hÃ ng tá»« khÃ¡ch
DAMAGED       â†’ HÃ ng há»ng/máº¥t
```

---

## ğŸ›’ 4. Order Database (order_db)

**Service Port**: 8083

### ERD Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              carts                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                               â”‚
â”‚    user_id (nullable)               â”‚
â”‚    session_id (for anonymous)       â”‚
â”‚    status                           â”‚
â”‚    currency                         â”‚
â”‚    subtotal                         â”‚
â”‚    discount_amount                  â”‚
â”‚    total                            â”‚
â”‚    coupon_code                      â”‚
â”‚    expires_at                       â”‚
â”‚    created_at                       â”‚
â”‚    updated_at                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ 1:N
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            cart_items                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                               â”‚
â”‚ FK cart_id                          â”‚
â”‚    product_id                       â”‚
â”‚    quantity                         â”‚
â”‚    unit_price                       â”‚
â”‚    subtotal                         â”‚
â”‚    created_at                       â”‚
â”‚    updated_at                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              orders                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                                                                 â”‚
â”‚    order_number (UNIQUE, e.g., ORD-20260107-0001)                    â”‚
â”‚    user_id (ref: identity_db.users)                                  â”‚
â”‚                                                                       â”‚
â”‚    â”€â”€â”€ Status â”€â”€â”€                                                    â”‚
â”‚    status (PENDING/CONFIRMED/PROCESSING/SHIPPED/DELIVERED/CANCELLED) â”‚
â”‚                                                                       â”‚
â”‚    â”€â”€â”€ Pricing â”€â”€â”€                                                   â”‚
â”‚    currency (VND)                                                    â”‚
â”‚    subtotal                                                          â”‚
â”‚    shipping_fee                                                      â”‚
â”‚    discount_amount                                                   â”‚
â”‚    tax_amount                                                        â”‚
â”‚    total_amount                                                      â”‚
â”‚                                                                       â”‚
â”‚    â”€â”€â”€ Coupon â”€â”€â”€                                                    â”‚
â”‚    coupon_id                                                         â”‚
â”‚    coupon_code                                                       â”‚
â”‚                                                                       â”‚
â”‚    â”€â”€â”€ Shipping Address (Denormalized) â”€â”€â”€                           â”‚
â”‚    shipping_recipient_name                                           â”‚
â”‚    shipping_phone                                                    â”‚
â”‚    shipping_province                                                 â”‚
â”‚    shipping_district                                                 â”‚
â”‚    shipping_ward                                                     â”‚
â”‚    shipping_address                                                  â”‚
â”‚    shipping_postal_code                                              â”‚
â”‚                                                                       â”‚
â”‚    â”€â”€â”€ Shipping Info â”€â”€â”€                                             â”‚
â”‚    shipping_method (STANDARD/EXPRESS/SAME_DAY)                       â”‚
â”‚    shipping_carrier                                                  â”‚
â”‚    tracking_number                                                   â”‚
â”‚    estimated_delivery_date                                           â”‚
â”‚    actual_delivery_date                                              â”‚
â”‚                                                                       â”‚
â”‚    â”€â”€â”€ Payment â”€â”€â”€                                                   â”‚
â”‚    payment_method (COD/BANK_TRANSFER/VNPAY/MOMO/ZALOPAY)            â”‚
â”‚    payment_status (PENDING/PAID/FAILED/REFUNDED)                    â”‚
â”‚    paid_at                                                           â”‚
â”‚                                                                       â”‚
â”‚    â”€â”€â”€ Notes â”€â”€â”€                                                     â”‚
â”‚    customer_note                                                     â”‚
â”‚    admin_note                                                        â”‚
â”‚    cancel_reason                                                     â”‚
â”‚    cancelled_at                                                      â”‚
â”‚    cancelled_by                                                      â”‚
â”‚                                                                       â”‚
â”‚    created_at                                                        â”‚
â”‚    updated_at                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                               â”‚
                    â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          order_items           â”‚  â”‚     order_status_history       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                          â”‚  â”‚ PK id                          â”‚
â”‚ FK order_id                    â”‚  â”‚ FK order_id                    â”‚
â”‚    product_id                  â”‚  â”‚    from_status                 â”‚
â”‚                                â”‚  â”‚    to_status                   â”‚
â”‚    â”€â”€â”€ Denormalized â”€â”€â”€        â”‚  â”‚    notes                       â”‚
â”‚    product_sku                 â”‚  â”‚    changed_by                  â”‚
â”‚    product_name                â”‚  â”‚    created_at                  â”‚
â”‚    product_image               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                â”‚
â”‚    quantity                    â”‚
â”‚    unit_price                  â”‚
â”‚    discount_amount             â”‚
â”‚    subtotal                    â”‚
â”‚                                â”‚
â”‚    â”€â”€â”€ Returns â”€â”€â”€             â”‚
â”‚    returned_quantity           â”‚
â”‚    refunded_amount             â”‚
â”‚    created_at                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Order Status Flow

```
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   PENDING     â”‚
                          â”‚ (Äang chá»)    â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                           â”‚
                    â–¼                           â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  CONFIRMED    â”‚           â”‚  CANCELLED    â”‚
           â”‚  (ÄÃ£ xÃ¡c nháº­n)â”‚           â”‚   (ÄÃ£ há»§y)    â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  PROCESSING   â”‚
           â”‚ (Äang xá»­ lÃ½)  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚    SHIPPED    â”‚
           â”‚ (ÄÃ£ gá»­i hÃ ng) â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚
         â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DELIVERED   â”‚   â”‚   RETURNED    â”‚
â”‚ (ÄÃ£ giao hÃ ng)â”‚   â”‚  (Tráº£ hÃ ng)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚
        â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   COMPLETED   â”‚   â”‚   REFUNDED    â”‚
â”‚ (HoÃ n thÃ nh)  â”‚   â”‚  (HoÃ n tiá»n)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’³ 5. Payment Database (payment_db)

**Service Port**: New Service

### ERD Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  payments                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                                         â”‚
â”‚    payment_code (UNIQUE)                      â”‚
â”‚    order_id (ref: order_db.orders)            â”‚
â”‚    user_id (ref: identity_db.users)           â”‚
â”‚                                               â”‚
â”‚    amount                                     â”‚
â”‚    currency                                   â”‚
â”‚                                               â”‚
â”‚    payment_method (ENUM)                      â”‚
â”‚    payment_gateway                            â”‚
â”‚                                               â”‚
â”‚    status (PENDING/PROCESSING/COMPLETED/...)  â”‚
â”‚                                               â”‚
â”‚    â”€â”€â”€ Gateway Response â”€â”€â”€                   â”‚
â”‚    gateway_transaction_id                     â”‚
â”‚    gateway_response_code                      â”‚
â”‚    gateway_response_message                   â”‚
â”‚                                               â”‚
â”‚    â”€â”€â”€ Bank Info â”€â”€â”€                          â”‚
â”‚    bank_code                                  â”‚
â”‚    bank_transaction_no                        â”‚
â”‚                                               â”‚
â”‚    paid_at                                    â”‚
â”‚    failed_at                                  â”‚
â”‚    ip_address                                 â”‚
â”‚    user_agent                                 â”‚
â”‚    notes                                      â”‚
â”‚    created_at                                 â”‚
â”‚    updated_at                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ 1:N
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   refunds                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                                         â”‚
â”‚    refund_code (UNIQUE)                       â”‚
â”‚ FK payment_id                                 â”‚
â”‚    order_id                                   â”‚
â”‚                                               â”‚
â”‚    amount                                     â”‚
â”‚    reason                                     â”‚
â”‚                                               â”‚
â”‚    status                                     â”‚
â”‚    gateway_refund_id                          â”‚
â”‚    gateway_response_code                      â”‚
â”‚                                               â”‚
â”‚    processed_by                               â”‚
â”‚    processed_at                               â”‚
â”‚    notes                                      â”‚
â”‚    created_at                                 â”‚
â”‚    updated_at                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ 6. Promotion Database (promotion_db)

**Service Port**: New Service

### ERD Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   coupons                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                                           â”‚
â”‚    code (UNIQUE, e.g., SALE50)                  â”‚
â”‚    name                                         â”‚
â”‚    description                                  â”‚
â”‚                                                 â”‚
â”‚    discount_type (PERCENTAGE/FIXED/FREE_SHIP)   â”‚
â”‚    discount_value                               â”‚
â”‚                                                 â”‚
â”‚    â”€â”€â”€ Limits â”€â”€â”€                               â”‚
â”‚    minimum_order_amount                         â”‚
â”‚    maximum_discount_amount                      â”‚
â”‚                                                 â”‚
â”‚    â”€â”€â”€ Usage Limits â”€â”€â”€                         â”‚
â”‚    usage_limit                                  â”‚
â”‚    usage_limit_per_user                         â”‚
â”‚    usage_count                                  â”‚
â”‚                                                 â”‚
â”‚    â”€â”€â”€ Validity â”€â”€â”€                             â”‚
â”‚    start_date                                   â”‚
â”‚    end_date                                     â”‚
â”‚    is_active                                    â”‚
â”‚                                                 â”‚
â”‚    â”€â”€â”€ Targeting â”€â”€â”€                            â”‚
â”‚    applies_to (ALL/PRODUCTS/CATEGORIES)         â”‚
â”‚    user_type (ALL/NEW_USER/VIP)                 â”‚
â”‚                                                 â”‚
â”‚    created_by                                   â”‚
â”‚    created_at                                   â”‚
â”‚    updated_at                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚             â”‚                         â”‚
     â–¼             â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚coupon_     â”‚ â”‚coupon_       â”‚ â”‚   coupon_usage     â”‚
â”‚products    â”‚ â”‚categories    â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ PK id              â”‚
â”‚ FK coupon  â”‚ â”‚ FK coupon    â”‚ â”‚ FK coupon_id       â”‚
â”‚    product â”‚ â”‚    category  â”‚ â”‚    user_id         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    order_id        â”‚
                                â”‚    discount_amount â”‚
                                â”‚    used_at         â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                flash_sales                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                                         â”‚
â”‚    name                                       â”‚
â”‚    description                                â”‚
â”‚    banner_url                                 â”‚
â”‚    start_time                                 â”‚
â”‚    end_time                                   â”‚
â”‚    status (UPCOMING/ACTIVE/ENDED)             â”‚
â”‚    is_active                                  â”‚
â”‚    created_at                                 â”‚
â”‚    updated_at                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ 1:N
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            flash_sale_products                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                                         â”‚
â”‚ FK flash_sale_id                              â”‚
â”‚    product_id                                 â”‚
â”‚    flash_sale_price                           â”‚
â”‚    original_price                             â”‚
â”‚    quantity_limit                             â”‚
â”‚    quantity_sold                              â”‚
â”‚    per_user_limit                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”” 7. Notification Database (notification_db)

**Service Port**: 8085

### ERD Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          notification_templates                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                                         â”‚
â”‚    code (UNIQUE, e.g., ORDER_CREATED)         â”‚
â”‚    name                                       â”‚
â”‚    channel (EMAIL/SMS/PUSH/IN_APP)            â”‚
â”‚    subject                                    â”‚
â”‚    body (Template with #{placeholders})       â”‚
â”‚    is_active                                  â”‚
â”‚    created_at                                 â”‚
â”‚    updated_at                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ 1:N
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               notifications                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                                         â”‚
â”‚    user_id (ref: identity_db.users)           â”‚
â”‚ FK template_id                                â”‚
â”‚                                               â”‚
â”‚    channel (EMAIL/SMS/PUSH/IN_APP)            â”‚
â”‚    title                                      â”‚
â”‚    message                                    â”‚
â”‚                                               â”‚
â”‚    recipient_email                            â”‚
â”‚    recipient_phone                            â”‚
â”‚                                               â”‚
â”‚    status (PENDING/SENT/DELIVERED/FAILED/READ)â”‚
â”‚                                               â”‚
â”‚    reference_type                             â”‚
â”‚    reference_id                               â”‚
â”‚                                               â”‚
â”‚    sent_at                                    â”‚
â”‚    read_at                                    â”‚
â”‚    error_message                              â”‚
â”‚    created_at                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       user_notification_preferences            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id                                         â”‚
â”‚    user_id (UNIQUE)                           â”‚
â”‚                                               â”‚
â”‚    email_order_updates                        â”‚
â”‚    email_promotions                           â”‚
â”‚    email_newsletter                           â”‚
â”‚                                               â”‚
â”‚    sms_order_updates                          â”‚
â”‚    sms_promotions                             â”‚
â”‚                                               â”‚
â”‚    push_enabled                               â”‚
â”‚    push_order_updates                         â”‚
â”‚    push_promotions                            â”‚
â”‚                                               â”‚
â”‚    created_at                                 â”‚
â”‚    updated_at                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Database Statistics Summary

| Database | Tables | Est. Size (1 year) | Read/Write Ratio |
|----------|--------|-------------------|------------------|
| identity_db | 6 | 1-5 GB | 90:10 |
| product_db | 9 | 5-20 GB | 95:5 |
| inventory_db | 4 | 2-10 GB | 60:40 |
| order_db | 5 | 10-50 GB | 50:50 |
| payment_db | 2 | 5-20 GB | 40:60 |
| promotion_db | 5 | 1-5 GB | 80:20 |
| notification_db | 3 | 5-20 GB | 20:80 |

---

## ğŸ”— Cross-Service Data References

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DATA OWNERSHIP & REFERENCES                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  identity_db.users.id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚                                                           â”‚
â”‚         â”œâ”€â”€â–º product_db.product_reviews.user_id                     â”‚
â”‚         â”œâ”€â”€â–º product_db.wishlists.user_id                           â”‚
â”‚         â”œâ”€â”€â–º order_db.carts.user_id                                 â”‚
â”‚         â”œâ”€â”€â–º order_db.orders.user_id                                â”‚
â”‚         â”œâ”€â”€â–º payment_db.payments.user_id                            â”‚
â”‚         â”œâ”€â”€â–º promotion_db.coupon_usage.user_id                      â”‚
â”‚         â”œâ”€â”€â–º notification_db.notifications.user_id                  â”‚
â”‚         â””â”€â”€â–º notification_db.user_notification_preferences.user_id  â”‚
â”‚                                                                      â”‚
â”‚  product_db.products.id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚                                                           â”‚
â”‚         â”œâ”€â”€â–º inventory_db.inventory.product_id                      â”‚
â”‚         â”œâ”€â”€â–º order_db.cart_items.product_id                         â”‚
â”‚         â”œâ”€â”€â–º order_db.order_items.product_id                        â”‚
â”‚         â”œâ”€â”€â–º promotion_db.coupon_products.product_id                â”‚
â”‚         â””â”€â”€â–º promotion_db.flash_sale_products.product_id            â”‚
â”‚                                                                      â”‚
â”‚  order_db.orders.id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚                                                           â”‚
â”‚         â”œâ”€â”€â–º inventory_db.stock_reservations.order_id               â”‚
â”‚         â”œâ”€â”€â–º payment_db.payments.order_id                           â”‚
â”‚         â””â”€â”€â–º promotion_db.coupon_usage.order_id                     â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›¡ï¸ Data Consistency Strategies

### 1. **Saga Pattern for Distributed Transactions**
```
Order Creation Saga:
1. Create Order (Order Service) â”€â”€â”€â–º Pending
2. Reserve Stock (Inventory Service) â”€â”€â”€â–º Success/Fail
3. Process Payment (Payment Service) â”€â”€â”€â–º Success/Fail
4. Confirm Order (Order Service) â”€â”€â”€â–º Confirmed

Compensation (if any step fails):
- Release stock reservation
- Refund payment
- Cancel order
```

### 2. **Event Sourcing for Audit**
```
inventory_movements table captures ALL stock changes
order_status_history table captures ALL order state changes
user_login_history table captures ALL login attempts
```

### 3. **Optimistic Locking**
```sql
-- inventory.version column prevents race conditions
UPDATE inventory 
SET quantity = quantity - 1, version = version + 1
WHERE id = ? AND version = ?
```

---

## ğŸ“ Notes

- **Denormalization**: Order items store product info at order time (price, name) for historical accuracy
- **Soft Delete**: Use `is_active` flags instead of DELETE for audit purposes
- **Timestamps**: All tables include `created_at`, most include `updated_at`
- **Indexes**: Optimized for common query patterns (user lookup, order status, stock checks)
- **Character Set**: UTF8MB4 for full Unicode support (including emojis)

---

**Last Updated**: 2026-01-07
